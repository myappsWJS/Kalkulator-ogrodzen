<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalkulator ogrodzeń</title>
<style>
  body { font-family: Arial, sans-serif; background: #ccc; padding: 20px; text-align: center; margin: 0; }
  .container { width: 100%; max-width: 800px; margin: auto; display: none; }
  h2 { background: limegreen; color: black; padding: 10px; margin: 0 auto 15px auto; }
  table { border-collapse: collapse; margin: 10px auto; width: 100%; }
  td, th { border: 1px solid #000; padding: 5px; text-align: center; }
  .label-cell { background: #aaa; text-align: left; padding-left: 10px; font-weight: bold; }
  .input-cell { background: yellow; text-align: center; }
  .input-cell input, .input-cell select { width: 100%; box-sizing: border-box; padding: 4px; font-size: 14px; text-align: center; }
  .header-row { background: cyan; font-weight: bold; }
  .result-row td { background: #00e5ff; }
  .sum-row td { background: #ffeb3b; font-weight: bold; }
  button { margin-top: 10px; padding: 8px 14px; font-size: 14px; cursor: pointer; }
  #wyniki { display: none; }
  #login-box { margin: 100px auto; background: #fff; padding: 30px; width: 300px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.4); }
  @media (max-width: 600px) {
    body { padding: 10px; }
    h2 { font-size: 1.1rem; padding: 8px; }
    td, th { font-size: 0.85rem; padding: 4px; }
    .input-cell input, .input-cell select { font-size: 0.9rem; }
    #login-box { width: 90%; padding: 20px; }
  }
</style>
</head>
<body>

<!-- ekran logowania -->
<div id="login-box">
  <h2>Logowanie</h2>
  <input type="password" id="login-pass" placeholder="Wpisz kod dostępu">
  <br><br>
  <button id="login-btn">Zaloguj</button>
  <p id="login-msg" style="color:red; display:none;">Błędny kod!</p>
</div>

<!-- główna aplikacja -->
<div class="container">
  <h2>Kalkulator ogrodzeń z siatki</h2>

  <table>
    <tr>
      <td class="label-cell">Długość całkowita ogrodzenia (m)</td>
      <td class="input-cell" colspan="3"><input type="number" id="dlugosc" value="0" min="0" step="0.1"></td>
    </tr>
    <tr>
      <td class="label-cell">Ilość narożników</td>
      <td class="input-cell" colspan="3">
        <select id="narozniki"><option>0</option><option>1</option><option>2</option><option>3</option></select>
      </td>
    </tr>
    <tr>
      <td class="label-cell">Wysokość ogrodzenia</td>
      <td class="input-cell" colspan="3">
        <select id="wysokosc">
          <option value="">Wybierz</option>
          <option value="1">1</option>
          <option value="1.2">1,2</option>
          <option value="1.5">1,5</option>
        </select>
      </td>
    </tr>
    <tr>
      <td class="label-cell">Kolor ogrodzenia</td>
      <td class="input-cell" colspan="3">
        <select id="kolor">
          <option value="">Wybierz</option>
          <option value="Ant">Antracyt</option>
          <option value="Zie">Zielony</option>
          <option value="Ocynk">Ocynk</option>
        </select>
      </td>
    </tr>
  </table>

  <table id="wyniki"></table>

  <button id="btnCalc">Oblicz</button>
</div>

<script>
const loginBox = document.getElementById("login-box");
const container = document.querySelector(".container");
const wynikiTable = document.getElementById("wyniki");

// logowanie
document.getElementById("login-btn").addEventListener("click", async () => {
  const pass = document.getElementById("login-pass").value;
  const res = await fetch("/api/kalkulator?mode=login&pass=" + encodeURIComponent(pass));
  const data = await res.json();
  if(data.ok){
    loginBox.style.display = "none";
    container.style.display = "block";
  } else {
    document.getElementById("login-msg").style.display = "block";
  }
});

// renderowanie tabeli z obsługą "wybierz rodzaj"
function renderTable(data){
  wynikiTable.style.display = "table";
  wynikiTable.innerHTML = `
    <tr class="header-row">
      <th>Referencja</th>
      <th>Nazwa</th>
      <th>Cena</th>
      <th>Ilość</th>
      <th>Wartość</th>
    </tr>
  `;

  data.rows.forEach(row => {
    const tr = document.createElement("tr");
    tr.classList.add("result-row");

    if(Array.isArray(row) && row.length > 1){
      // kilka wariantów → select
      tr.innerHTML = `
        <td></td>
        <td colspan="4">
          <select class="variant-select">
            <option value="">Wybierz rodzaj</option>
            ${row.map(r => 
              `<option value="${r.ref}" data-cena="${r.cena}" data-qty="${r.qty}">
                ${r.nazwa} — ${r.cena.toFixed(2)} zł
              </option>`
            ).join("")}
          </select>
        </td>
      `;
    } else {
      // pojedynczy wariant
      const p = Array.isArray(row) ? row[0] : row;
      tr.innerHTML = `
        <td>${p.ref}</td>
        <td>${p.nazwa}</td>
        <td>${p.cena.toFixed(2)}</td>
        <td>${p.qty}</td>
        <td>${(p.cena * p.qty).toFixed(2)}</td>
      `;
    }
    wynikiTable.appendChild(tr);
  });

  // suma na końcu
  wynikiTable.innerHTML += `
    <tr class="sum-row"><td colspan="4">SUMA</td><td>${data.suma.toFixed(2)}</td></tr>
  `;

  // obsługa wyboru wariantu
  wynikiTable.querySelectorAll(".variant-select").forEach(sel => {
    sel.addEventListener("change", e => {
      const opt = e.target.selectedOptions[0];
      if(opt.value){
        const tr = e.target.closest("tr");
        tr.innerHTML = `
          <td>${opt.value}</td>
          <td>${opt.textContent.split(" — ")[0]}</td>
          <td>${parseFloat(opt.dataset.cena).toFixed(2)}</td>
          <td>${opt.dataset.qty}</td>
          <td>${(opt.dataset.cena * opt.dataset.qty).toFixed(2)}</td>
        `;
      }
    });
  });
}

// przycisk oblicz
document.getElementById("btnCalc").addEventListener("click", async () => {
  const payload = {
    dlugosc: parseFloat(document.getElementById("dlugosc").value)||0,
    narozniki: parseInt(document.getElementById("narozniki").value)||0,
    wysokosc: document.getElementById("wysokosc").value,
    kolor: document.getElementById("kolor").value
  };

  const res = await fetch("/api/kalkulator", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if(!data.ok){ alert("Błąd kalkulacji"); return; }
  renderTable(data);
});
</script>
</body>
</html>
